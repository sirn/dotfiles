---
## Install dnscrypt-proxy
##

- name: install dnscrypt-proxy service
  homebrew:
    name: dnscrypt-proxy
    state: latest
  notify:
    - restart dnscrypt-proxy launchd service


## Configure dnscrypt-proxy
##

- name: ensure dnscrypt-proxy directories
  become: yes
  file:
    path: "{{item}}"
    state: directory
    recurse: yes
    owner: nobody
    group: nobody
  with_items:
    - /usr/local/svcs/dnscrypt-proxy/etc
    - /usr/local/svcs/dnscrypt-proxy/var

- name: configure dnscrypt-proxy
  become: yes
  copy:
    src: dnscrypt-proxy/dnscrypt-proxy.toml
    dest: /usr/local/svcs/dnscrypt-proxy/etc/dnscrypt-proxy.toml
    owner: nobody
    group: nobody
  notify:
    - restart dnscrypt-proxy launchd service


## Register dnscrypt-proxy service
##

- name: enable dnscrypt-proxy service
  become: yes
  copy:
    src: dnscrypt-proxy/com.github.jedisct1.dnscrypt-proxy.plist
    dest: /Library/LaunchDaemons/com.github.jedisct1.dnscrypt-proxy.plist
  notify:
    - restart dnscrypt-proxy launchd service
