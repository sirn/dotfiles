#!/bin/sh
#
# Wrapper for glibc root.
#

BASENAME=$(basename "$0")
NEWROOT=$HOME/.local/share/glibc

if ! command -v bwrap >/dev/null; then
    printf >&2 "%s: bwrap not installed\\n" "$BASENAME"
    exit 1
fi

if [ ! -d "$NEWROOT" ]; then
    printf >&2 "%s: no glibc root\\n" "$BASENAME"
    exit 1
fi

for dir in /var/opt /opt; do
    if [ ! -d "$dir" ]; then
        printf >&2 "%s does not exists, creating...\\n" "$dir"
        sudo mkdir -p "$dir"
        sudo chmod 0755 "$dir"
    fi
done

exec bwrap \
     --bind / / \
     --bind "$NEWROOT"/usr /usr \
     --bind "$NEWROOT"/opt /opt \
     --bind "$NEWROOT"/var/db/xbps /var/db/xbps \
     --bind "$NEWROOT"/var/opt /var/opt \
     --proc /proc \
     --dev /dev \
     --unshare-user \
     -- \
     "$@"
